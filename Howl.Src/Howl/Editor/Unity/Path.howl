⊐ System.Collections.Generic;
⊐ UnityEditor;
⊐ Env = System.Environment; ⊐ SysPath = System.IO.Path;
⊐ InvOp = System.InvalidOperationException;
⊐ UnityEngine;

⊓ Active.Howl{
‒̥ ○ Path{

    ᴸ ㄹ ROOT_TOKEN = "howl.root";  ‒̥ ㄹ _Howl = ".howl", _Cs = ".cs";

    // --------------------------------------------------------------

    ‒̥ ┈ AvailHowlRoot(){
        ∙ ρ = GetHowlRoot ();
        ⤴ (ρ.didCreate) Debug.Log($"Created Howl root: {ρ.path}");
    }

    ‒̥ ㄹ Expand(⦿ ㄹ path) → path
    .Replace("~",
        Env.GetFolderPath(Env.SpecialFolder.UserProfile))
    .Replace("%APPDATA%",
        Env.GetFolderPath(Env.SpecialFolder.ApplicationData))
    .Nix();

    ‒̥ ㄹ FullPath(⦿ ㄹ π) → SysPath.GetFullPath(π).Nix();

    ‒̥ ㄹ FindHowlRoot(){
        ㄹ root = FileSystem.Path("Assets/", ROOT_TOKEN);
        ⤴ (root ☰ ∅) ⮐ ∅;
        ⤵ {
            // TODO don't want a sep at end but noticed too late.
            ∙ dir = root.DirName() + "/";
            ᆞ i = dir.IndexOf("Assets/");
            ⮐ dir.Substring(i);
        }
    }

    ‒̥ ㅇ HasExtension(⦿ ㄹ π, ㄹ ext) → π.EndsWith(ext);

    ‒̥ 𝕃<ㄹ> GUIDsToDirs(⦿ ㄹ[] ㅂ){
        ∙ ㄸ = ⌢ 𝕃<ㄹ>();
        ∀ (∙ guid ∈ ㅂ){
            ∙ π = AssetDatabase.GUIDToAssetPath(guid);
            ⤴(System.IO.Directory.Exists(π)) ㄸ.Add(π);
        }
        ⮐ ㄸ;
    }

    ‒̥ ㅇ InAssets(⦿ ㄹ path)
    → path.StartsWith("Assets/") ∨ path.StartsWith("Assets" + '\\');

    ‒̥ ㅇ InHowlPath(⦿ ㄹ π) → π.StartsWith(howlRoot);

    ‒̥ ㅇ IsHowlBound(⦿ ㄹ π) → π.InPath().Exists();

    ‒̥ ㅇ IsPackaged(⦿ ㄹ π) → π.StartsWith("Packages/");

    ‒̥ ㅇ IsDetachedHowlSource(⦿ ㄹ π) → π.EndsWith(_Howl);

    ‒̥ ㅇ IsHowlSource(⦿ ㄹ π)
    → π.FullPath().StartsWith(howlRoot.FullPath());

    ‒̥ ㅇ IsCSharpSource(⦿ ㄹ π) → π.EndsWith(".cs");

    ‒̥ ㄹ Nix(⦿ ㄹ x) → x.Replace('\\', '/');

    ‒̥ ㄹ NoFinalSep(⦿ ㄹ π)
    → (π = π.Nix()).EndsWith("/") ? π.Substring (0, π❙ - 1) : π;

    ‒̥ ㄹ SetExtension(⦿ ㄹ π, ㄹ ext)
    → SysPath.ChangeExtension(π, ext);

    // --------------------------------------------------------------

    // Given path to a C# file or a directory outside the howl path,
    // return matching Howl path
    ‒̥ string InPath(this string ㅂ){
        if(!ㅂ.InAssets()){
            var i = ㅂ.IndexOf("Assets");
            if(i < 0) throw new InvOp($"{ㅂ} not in Assets/");
            ㅂ = ㅂ.Substring(i);
        }
        ㅂ = ㅂ.Substring("Assets/"❙);
        var  ㄸ = ㅂ.HasExtension(_Cs) ? ㅂ.SetExtension(_Howl) : ㅂ;
        return $"{howlRoot}{ㄸ}";
    }

    // Given path to a howl, or directory on the howl path
    // return matching C#/export path
    ‒̥ string OutPath(this string ㅂ){
        if (!ㅂ.IsHowlSource())
            throw new InvOp($"{ㅂ} doesn't howl");
        var π     = ㅂ.FullPath();
        var @base = howlRoot.FullPath();
        if (!π.StartsWith(@base))
            throw new InvOp($"{ㅂ} not in howl path");
        π = π.Substring(@base❙);
        var  ㄸ = π.HasExtension(_Howl) ? π.SetExtension(_Cs) : π;
        return "Assets/" + ㄸ;
   }

    // Properties ---------------------------------------------------

    ‒̥ ㅇ howlRootExists → FindHowlRoot() ≠ ∅;

    ‒̥ ㄹ howlRoot → GetHowlRoot().path;

    ‒̥ ㄹ defaultHowlRootPath → $"Assets/{projectName}.Howl/";

    // NOTE: App.dataPath uses forward slashes, even on Windows
    ‒̥ ㄹ projectName{ ╭{
        ㄹ[] s = Application.dataPath.Split('/');
        ⮐ s[s❙ - 2];
    }}

    // PRIVATE ------------------------------------------------------

    ∘ (ㄹ path, ㅇ didCreate) GetHowlRoot(){
        ∙ root = FindHowlRoot();
        ⤴ (root ☰ ∅){
            root = defaultHowlRootPath;
            (root + ROOT_TOKEN).Write("ROOT", mkdir: ✓);
            ⮐  (root, ✓);
        } ⤵
            ⮐ (root, ✗);
    }

}}
