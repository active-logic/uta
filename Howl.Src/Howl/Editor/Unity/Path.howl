âŠ System.Collections.Generic;
âŠ UnityEditor;
âŠ Env = System.Environment; âŠ SysPath = System.IO.Path;
âŠ InvOp = System.InvalidOperationException;
âŠ UnityEngine;

âŠ“ Active.Howl{
â€’Ì¥ â—‹ Path{

    á´¸ ã„¹ ROOT_TOKEN = "howl.root";  â€’Ì¥ ã„¹ _Howl = ".howl", _Cs = ".cs";

    // --------------------------------------------------------------

    â€’Ì¥ â”ˆ AvailHowlRoot(){
        âˆ™ Ï = GetHowlRoot ();
        â¤´ (Ï.didCreate) Debug.Log($"Created Howl root: {Ï.path}");
    }

    â€’Ì¥ ã„¹ Expand(â¦¿ ã„¹ path) â†’ path
    .Replace("~",
        Env.GetFolderPath(Env.SpecialFolder.UserProfile))
    .Replace("%APPDATA%",
        Env.GetFolderPath(Env.SpecialFolder.ApplicationData))
    .Nix();

    â€’Ì¥ ã„¹ FullPath(â¦¿ ã„¹ Ï€) â†’ SysPath.GetFullPath(Ï€).Nix();

    â€’Ì¥ ã„¹ FindHowlRoot(){
        ã„¹ root = FileSystem.Path("Assets/", ROOT_TOKEN);
        â¤´ (root â˜° âˆ…) â® âˆ…;
        â¤µ {
            // TODO don't want a sep at end but noticed too late.
            âˆ™ dir = root.DirName() + "/";
            á† i = dir.IndexOf("Assets/");
            â® dir.Substring(i);
        }
    }

    â€’Ì¥ ã…‡ HasExtension(â¦¿ ã„¹ Ï€, ã„¹ ext) â†’ Ï€.EndsWith(ext);

    â€’Ì¥ ğ•ƒ<ã„¹> GUIDsToDirs(â¦¿ ã„¹[] ã…‚){
        âˆ™ ã„¸ = âŒ¢ ğ•ƒ<ã„¹>();
        âˆ€ (âˆ™ guid âˆˆ ã…‚){
            âˆ™ Ï€ = AssetDatabase.GUIDToAssetPath(guid);
            â¤´(System.IO.Directory.Exists(Ï€)) ã„¸.Add(Ï€);
        }
        â® ã„¸;
    }

    â€’Ì¥ ã…‡ InAssets(â¦¿ ã„¹ path)
    â†’ path.StartsWith("Assets/") âˆ¨ path.StartsWith("Assets" + '\\');

    â€’Ì¥ ã…‡ InHowlPath(â¦¿ ã„¹ Ï€) â†’ Ï€.StartsWith(howlRoot);

    â€’Ì¥ ã…‡ IsHowlBound(â¦¿ ã„¹ Ï€) â†’ Ï€.InPath().Exists();

    â€’Ì¥ ã…‡ IsPackaged(â¦¿ ã„¹ Ï€) â†’ Ï€.StartsWith("Packages/");

    â€’Ì¥ ã…‡ IsDetachedHowlSource(â¦¿ ã„¹ Ï€) â†’ Ï€.EndsWith(_Howl);

    â€’Ì¥ ã…‡ IsHowlSource(â¦¿ ã„¹ Ï€)
    â†’ Ï€.FullPath().StartsWith(howlRoot.FullPath());

    â€’Ì¥ ã…‡ IsCSharpSource(â¦¿ ã„¹ Ï€) â†’ Ï€.EndsWith(".cs");

    â€’Ì¥ ã„¹ Nix(â¦¿ ã„¹ x) â†’ x.Replace('\\', '/');

    â€’Ì¥ ã„¹ NoFinalSep(â¦¿ ã„¹ Ï€)
    â†’ (Ï€ = Ï€.Nix()).EndsWith("/") ? Ï€.Substring (0, Ï€â™ - 1) : Ï€;

    â€’Ì¥ ã„¹ SetExtension(â¦¿ ã„¹ Ï€, ã„¹ ext)
    â†’ SysPath.ChangeExtension(Ï€, ext);

    // --------------------------------------------------------------

    // Given path to a C# file or a directory outside the howl path,
    // return matching Howl path
    â€’Ì¥ string InPath(this string ã…‚){
        if(!ã…‚.InAssets()){
            var i = ã…‚.IndexOf("Assets");
            if(i < 0) throw new InvOp($"{ã…‚} not in Assets/");
            ã…‚ = ã…‚.Substring(i);
        }
        ã…‚ = ã…‚.Substring("Assets/"â™);
        var  ã„¸ = ã…‚.HasExtension(_Cs) ? ã…‚.SetExtension(_Howl) : ã…‚;
        return $"{howlRoot}{ã„¸}";
    }

    // Given path to a howl, or directory on the howl path
    // return matching C#/export path
    â€’Ì¥ string OutPath(this string ã…‚){
        if (!ã…‚.IsHowlSource())
            throw new InvOp($"{ã…‚} doesn't howl");
        var Ï€     = ã…‚.FullPath();
        var @base = howlRoot.FullPath();
        if (!Ï€.StartsWith(@base))
            throw new InvOp($"{ã…‚} not in howl path");
        Ï€ = Ï€.Substring(@baseâ™);
        var  ã„¸ = Ï€.HasExtension(_Howl) ? Ï€.SetExtension(_Cs) : Ï€;
        return "Assets/" + ã„¸;
   }

    // Properties ---------------------------------------------------

    â€’Ì¥ ã…‡ howlRootExists â†’ FindHowlRoot() â‰  âˆ…;

    â€’Ì¥ ã„¹ howlRoot â†’ GetHowlRoot().path;

    â€’Ì¥ ã„¹ defaultHowlRootPath â†’ $"Assets/{projectName}.Howl/";

    // NOTE: App.dataPath uses forward slashes, even on Windows
    â€’Ì¥ ã„¹ projectName{ â•­{
        ã„¹[] s = Application.dataPath.Split('/');
        â® s[sâ™ - 2];
    }}

    // PRIVATE ------------------------------------------------------

    âˆ˜ (ã„¹ path, ã…‡ didCreate) GetHowlRoot(){
        âˆ™ root = FindHowlRoot();
        â¤´ (root â˜° âˆ…){
            root = defaultHowlRootPath;
            (root + ROOT_TOKEN).Write("ROOT", mkdir: âœ“);
            â®  (root, âœ“);
        } â¤µ
            â® (root, âœ—);
    }

}}
