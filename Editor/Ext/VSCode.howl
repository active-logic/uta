‚äê Ex = System.Exception;
‚äê System.Linq;
‚äê System.IO;
‚äê UnityEditor;

// REFS:
// https://dev.to/codechimp/creating-and-syncing-personal-snippets-in-vs-code-2g9m
// https://vscode-docs.readthedocs.io/en/stable/customization/userdefinedsnippets/

‚äì Active.Howl{
‚Äí ‚óã VSCode : Ed{

    ‚ÄíÃ• VSCode Œπ = ‚å¢ VSCode();

    #if UNITY_EDITOR_LINUX
    ·¥∏ „Ñπ userPrefsRoot = @"~/.config/Code/User";
    #elif UNITY_EDITOR_OSX
    ·¥∏ „Ñπ userPrefsRoot = @"~/Library/Application Support/Code/User";
    #elif UNITY_EDITOR_WIN
    ·¥∏ „Ñπ userPrefsRoot = @"%APPDATA%/Code/User";
    #endif

    ·¥∏ „Ñπ appDataRoot = @"~/.vscode/";
    ·¥∏ „Ñπ extensionsDir = @"~/.vscode/extensions";
    ·¥∏ „Ñπ defaultUserSnippetsPath = "snippets/howl.json";
    ·¥∏ „Ñπ userSnippetsPathKey = "VSCode.User.Snippets.Path";

    „Ñπ howlExtDir ‚Üí $"{extensionsDir.Expand()}/howl";

    ‚Äí „Ñπ Format(Snippet x) ‚Üí
        ($"  '{x.name}': {{\n"
      +  $"    'prefix': '{x.prefix}',\n"
      +  $"    'body': [ '{x.body}' ],\n"
      +   "  }").Replace('\'', '"');

    ‚Äí „Ñπ GenUserSnippets(„Öá dry){
        SideloadExtension();
        ‚àô snips = SnippetGen.Create();
        ‚àô „Ñ∏ = snips.Aggregate("", (x, y) ‚Üí $"{x},\n{Format(y)}")
               + '\n';
        DoExportSnippets(„Ñ∏ = „Ñ∏.Substring(2), dry);
        ‚Æê „Ñ∏;
    }

    // TODO when installed as a UPM package probably not the correct
    // source path
    // TODO sometimes we want to reinstall the extension
    ‚Äí ‚îà SideloadExtension(){
        ‚àô x = "Assets/Howl/Z/VSCodeX";
        ‚àô y = howlExtDir;
        ‚§¥ (!Directory.Exists(y)){
            x.Copy(to: y);
            üêö $"Howl support extension installed under {y}";
        }
    }

    ‚Äí „Ñπ UserSnippetsPath(„Öá expand)
    ‚Üí EditorPrefs.GetString(userSnippetsPathKey,
                             DefaultUserSnippetsPath(expand));

    ‚Äí ‚îà SetUserSnippetsPath(„Ñπ „ÖÇ)
    ‚Üí EditorPrefs.SetString(userSnippetsPathKey, „ÖÇ);

    ‚Äí „Ñπ DefaultUserSnippetsPath(„Öá expand){
        ‚àô „Ñ∏ = $"{userPrefsRoot}/{defaultUserSnippetsPath}";
        ‚Æê expand ? „Ñ∏.Expand() : „Ñ∏;
    }

    ‚Äí „Ñπ Name() ‚Üí nameof(VSCode);

    ‚Äí „Öá Exists() ‚Üí appDataRoot.Expand().IsDir();

    ‚Äí „Öá SupportsHowl() ‚Üí howlExtDir.Expand().IsDir();

    // --------------------------------------------------------------

    ‚îà DoExportSnippets(„Ñπ „ÖÇ, „Öá dry){
        „Ñπ œÄ = UserSnippetsPath(expand: ‚úì);
        ‚§¥ (!dry) œÄ.Write("{\n" + „ÖÇ + "\n}");
    }

}}
