âŠ Ex = System.Exception; âŠ System.Linq; âŠ System.IO;
âŠ UnityEditor;

// REFS:
// https://dev.to/codechimp/creating-and-syncing-personal-snippets-in-vs-code-2g9m
// https://vscode-docs.readthedocs.io/en/stable/customization/userdefinedsnippets/

âŠ“ Active.Howl{
â€’ â—‹ VSCode : Ed{

    â€’Ì¥ VSCode Î¹ = âŒ¢ VSCode();

    #if UNITY_EDITOR_LINUX
    á´¸ ã„¹ userPrefsRoot = "~/.config/Code/User";
    #elif UNITY_EDITOR_OSX
    á´¸ ã„¹ userPrefsRoot = "~/Library/Application Support/Code/User";
    #elif UNITY_EDITOR_WIN
    á´¸ ã„¹ userPrefsRoot = "%APPDATA%/Code/User";
    #endif

    á´¸ ã„¹ appDataRoot   = "~/.vscode/";
    á´¸ ã„¹ resourcePath  = "Howl/Z/VSCodeX";
    á´¸ ã„¹ extensionsDir = "~/.vscode/extensions";
    á´¸ ã„¹ defaultUserSnippetsPath = "snippets/howl.json";
    á´¸ ã„¹ userSnippetsPathKey = "VSCode.User.Snippets.Path";

    // <Ed> ---------------------------------------------------------

    â€’ ã„¹ GenUserSnippets(ã…‡ dry){
        SideloadExtension();
        âˆ™ snips = SnippetGen.Create();
        âˆ™ ã„¸ = snips.Aggregate("", (x, y) â†’ $"{x},\n{Format(y)}")
             + '\n';
        DoExportSnippets(ã„¸ = ã„¸.Substring(2), dry);
        â® ã„¸;
    }

    â€’ â”ˆ SetUserSnippetsPath(ã„¹ ã…‚)
    â†’ EditorPrefs.SetString(userSnippetsPathKey, ã…‚);

    â€’ ã„¹ UserSnippetsPath(ã…‡ expand)
    â†’ EditorPrefs.GetString(userSnippetsPathKey,
                             DefaultUserSnippetsPath(expand));

    â€’ ã„¹ DefaultUserSnippetsPath(ã…‡ expand){
        âˆ™ ã„¸ = $"{userPrefsRoot}/{defaultUserSnippetsPath}";
        â® expand ? ã„¸.Expand() : ã„¸;
    }

    â€’ ã„¹ Name() â†’ nameof(VSCode);

    â€’ ã…‡ Exists() â†’ appDataRoot.Expand().IsDir();

    â€’ ã…‡ SupportsHowl() â†’ howlExtDir.Expand().IsDir();

    // Implementation -----------------------------------------------

    â”ˆ DoExportSnippets(ã„¹ ã…‚, ã…‡ dry){
        ã„¹ Ï€ = UserSnippetsPath(expand: âœ“);
        â¤´ (!dry) Ï€.Write("{\n" + ã…‚ + "\n}");
    }

    â€’ ã„¹ Format(Snippet x) â†’
        ($"  '{x.name}': {{\n"
      +  $"    'prefix': '{x.prefix}',\n"
      +  $"    'body': [ '{x.body}' ],\n"
      +   "  }").Replace('\'', '"');

    // TODO transitional - should point users at an external package
    â€’ â”ˆ SideloadExtension(){
        âˆ™ Ï€ = howlExtDir; â¤´ (Ï€.Exists()) â® ;
        resourceDir.Copy(to: Ï€);
        ğŸš $"Howl support extension installed under {Ï€}";
    }

    // Properties ----------------------------------------------------

    â€’ ã„¹ resourceDir â†’ Path.FindResourceDir(resourcePath);

    ã„¹ howlExtDir â†’ $"{extensionsDir.Expand()}/howl";

}}
