âŠ System.Collections.Generic;
âŠ ArgEx = System.ArgumentException;
âŠ UnityEditor;
âŠ Env = System.Environment; âŠ SysPath = System.IO.Path;
âŠ InvOp = System.InvalidOperationException;
âŠ UnityEngine;

âŠ“ Active.Howl{
â€’Ì¥ â—‹ Path{

    á´¸ ã„¹ HOWL_ROOT_TOKEN       = "howl.root";
    á´¸ ã„¹ BUILD_ROOT_TOKEN = "howl.build";

    â€’Ì¥ ã„¹ _Howl = ".howl", _Cs = ".cs";

    // --------------------------------------------------------------

    â€’Ì¥ â”ˆ AvailHowlRoot(){
        âˆ™ Ï = GetHowlRoot ();
        â¤´ (Ï.didCreate) Debug.Log($"Created Howl root: {Ï.path}");
    }

    â€’Ì¥ ã„¹ Expand(â¦¿ ã„¹ path) â†’ path
    .Replace("~",
        Env.GetFolderPath(Env.SpecialFolder.UserProfile))
    .Replace("%APPDATA%",
        Env.GetFolderPath(Env.SpecialFolder.ApplicationData))
    .Nix();

    â€’Ì¥ ã„¹ FullPath(â¦¿ ã„¹ Ï€) â†’ SysPath.GetFullPath(Ï€).Nix();

    â€’Ì¥ ã…‡ HasBuildImage(â¦¿ ã„¹ Ï€){
        â¤´ (Ï€.In(buildRoot) âˆ¨ !Ï€.In(howlRoot)) â® âœ—;
        âˆ™ Î± = buildRoot + Ï€.RelativeTo(howlRoot);
        â¤´ (Î±.TypeIs(_Howl)) Î± = Î±.SetExtension(_Cs);
        â® Î±.Exists();
    }

    â€’Ì¥ ã…‡ TypeIs(â¦¿ ã„¹ Ï€, ã„¹ ext) â†’ Ï€.EndsWith(ext);

    â€’Ì¥ ğ•ƒ<ã„¹> GUIDsToDirs(â¦¿ ã„¹[] ã…‚){
        âˆ™ ã„¸ = âŒ¢ ğ•ƒ<ã„¹>();
        âˆ€ (âˆ™ guid âˆˆ ã…‚){
            âˆ™ Ï€ = AssetDatabase.GUIDToAssetPath(guid);
            â¤´(System.IO.Directory.Exists(Ï€)) ã„¸.Add(Ï€);
        }
        â® ã„¸;
    }

    â€’Ì¥ ã…‡ InAssets(â¦¿ ã„¹ path)
    â†’ path.StartsWith("Assets/") âˆ¨ path.StartsWith("Assets" + '\\');

    â€’Ì¥ ã…‡ In(â¦¿ ã„¹ Ï€, ã„¹ â§•) â†’ Ï€.FullPath().StartsWith(â§•.FullPath());

    // TODO unreliable
    â€’Ì¥ ã…‡ InHowlPath(â¦¿ ã„¹ Ï€) â†’ Ï€.StartsWith(howlRoot);

    â€’Ì¥ ã…‡ IsHowlBound(â¦¿ ã„¹ Ï€) â†’ Ï€.In(buildRoot) ?
                              Ï€.SourcePath().Exists() : âœ—;

    â€’Ì¥ ã…‡ IsBuildRoot(â¦¿ ã„¹ Ï€) â†’ Ï€.FileName() â˜° BUILD_ROOT_TOKEN;

    â€’Ì¥ ã…‡ IsHowlRoot(â¦¿ ã„¹ Ï€) â†’ Ï€.FileName() â˜° HOWL_ROOT_TOKEN;

    â€’Ì¥ ã…‡ IsPackaged(â¦¿ ã„¹ Ï€) â†’ Ï€.StartsWith("Packages/");

    â€’Ì¥ ã…‡ IsDetachedHowlSource(â¦¿ ã„¹ Ï€) â†’ Ï€.EndsWith(_Howl);

    â€’Ì¥ ã…‡ IsHowlSource(â¦¿ ã„¹ Ï€) â†’ Ï€.TypeIs(_Howl) âˆ§ Ï€.In(howlRoot);

    â€’Ì¥ ã…‡ IsCSharpSource(â¦¿ ã„¹ Ï€) â†’ Ï€.EndsWith(".cs");

    â€’Ì¥ ã„¹ Nix(â¦¿ ã„¹ x) â†’ x.Replace('\\', '/');

    â€’Ì¥ ã„¹ NoFinalSep(â¦¿ ã„¹ Ï€)
    â†’ (Ï€ = Ï€.Nix()).EndsWith("/") ? Ï€.Substring (0, Ï€â™ - 1) : Ï€;

    â€’Ì¥ ã„¹ RelativeTo(â¦¿ ã„¹ Ï€, ã„¹ Îº){
        Ï€ = Ï€.FullPath(); Îº = Îº.FullPath();
        â¤´ (Îº[Îºâ™-1] â‰  '/') Îº += '/';
        â® Ï€.StartsWith(Îº) ? Ï€.Substring(Îºâ™)
                   : (â•¯Â°â–¡Â°)â•¯ âŒ¢ ArgEx($"{Ï€} is not a subpath of {Îº}");
    }

    â€’Ì¥ ã„¹ SetExtension(â¦¿ ã„¹ Ï€, ã„¹ ext) â†’ SysPath.ChangeExtension(Ï€, ext);

    // --------------------------------------------------------------

    // Given path to a C# file or a directory outside the howl path,
    // return matching Howl path
    â€’Ì¥ ã„¹ SourcePath(â¦¿ ã„¹ Ï€){
        Ï€ = howlRoot + Ï€.RelativeTo(buildRoot);
        â® Ï€.TypeIs(_Cs) ? Ï€.SetExtension(_Howl) : Ï€;
    }

    // Given path to howl source or a dir. on Howl path, return the
    // matching C#/export path
    â€’Ì¥ ã„¹ BuildPath(this ã„¹ ã…‚){
        â¤´(!ã…‚.In(howlRoot)) (â•¯Â°â–¡Â°)â•¯ âŒ¢ InvOp($"{ã…‚} not in Howl path");
        ã…‚ = ã…‚.RelativeTo(howlRoot);
        âˆ™ ã„¸ = ã…‚.TypeIs(_Howl) ? ã…‚.SetExtension(_Cs) : ã…‚;
        â® buildRoot + ã„¸;
   }

    // Properties ---------------------------------------------------

    â€’Ì¥ ã…‡ howlRootExists â†’ FindHowlRoot() â‰  âˆ…;

    â€’Ì¥ ã„¹ assets â†’ "Assets/";

    â€’Ì¥ ã„¹ howlRoot â†’ GetHowlRoot().path;

    â€’Ì¥ ã„¹ buildRoot â†’ GetRoot(defaultBuildRoot, BUILD_ROOT_TOKEN).path;

    â€’Ì¥ ã„¹ defaultHowlRoot â†’ $"{assets}{projectName}.Howl/";

    â€’Ì¥ ã„¹ defaultBuildRoot â†’ $"{assets}~build";

    // NOTE: App.dataPath uses forward slashes, even on Windows
    â€’Ì¥ ã„¹ projectName{ â•­{
        ã„¹[] s = Application.dataPath.Split('/');
        â® s[sâ™ - 2];
    }}

    // PRIVATE ------------------------------------------------------

    âˆ˜ (ã„¹ path, ã…‡ didCreate) GetRoot(ã„¹ @default, ã„¹ token
                                               , ã…‡ writeToken = âœ“){
        âˆ™ Ï = FindRoot(token);
        â¤´ (Ï â˜° âˆ…){
            â¤´ (writeToken) (@default + token).Write("0", mkdir: âœ“);
            â® (@default, âœ“);
        } â¤µ
            â® (Ï, âœ—);
    }

    â€’Ì¥ ã„¹ FindRoot(ã„¹ token){
        ã„¹ root = FileSystem.Path(assets, token);
        â¤´ (root â˜° âˆ…) â® âˆ…;
        â¤µ {
            âˆ™ dir = root.DirName() + "/";
            á† i = dir.IndexOf(assets);
            â® dir.Substring(i);
        }
    }

    // DEPRECATE - Use GetRoot
    âˆ˜ (ã„¹ path, ã…‡ didCreate) GetHowlRoot(){
        âˆ™ root = FindHowlRoot();
        â¤´ (root â˜° âˆ…){
            root = defaultHowlRoot;
            (root + HOWL_ROOT_TOKEN).Write("ROOT", mkdir: âœ“);
            â®  (root, âœ“);
        } â¤µ
            â® (root, âœ—);
    }

    // DEPRECATE - Use FindRoot
    â€’Ì¥ ã„¹ FindHowlRoot(){
        ã„¹ root = FileSystem.Path("Assets/", HOWL_ROOT_TOKEN);
        â¤´ (root â˜° âˆ…) â® âˆ…;
        â¤µ {
            // TODO don't want a sep at end but noticed too late.
            âˆ™ dir = root.DirName() + "/";
            á† i = dir.IndexOf("Assets/");
            â® dir.Substring(i);
        }
    }

}}
